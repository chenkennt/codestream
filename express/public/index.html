<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <title>Code Stream</title>
  <style>
    #editor {
      width: 100vw;
      height: calc(100vh - 3.5rem);
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand navbar-dark bg-dark">
    <span class="navbar-brand">CodeStream</span>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <span class="navbar-text">Stream ID: </span>
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" id="url" target="_blank" href="#"></a>
        </li>
      </ul>
      <span id="status" class="navbar-text"></span>
    </div>
  </nav>
  <div class="container-fluid">
    <div class="row">
      <div id="editor" class="col"></div>
    </div>
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.9/ace.min.js"></script>
  <script src="scripts/main.js"></script>
  <script>
    function createEditor(element, readOnly) {
      ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.9');
      let editor = ace.edit(element, {
        mode: 'ace/mode/javascript',
        readOnly: readOnly
      });
      editor.setTheme('ace/theme/tomorrow_night');
      return editor;
    }

    function updateStreamId(id) {
      let u = document.querySelector('#url');
      u.setAttribute('href', `${location.protocol}//${location.host}${location.pathname}#${id}`);
      u.textContent = id;
    }

    function updateStatus(status) {
      document.querySelector('#status').textContent = status;
    }

    function startStream(url) {
      let queue = [];
      let content = '';
      let version = 0;
      let audience = 0;
      let connection = new Connection(new WebSocket(url));
      function flush(getContent) {
        if (queue.length === 0) return;
        connection.send(queue, version);
        queue = [];
        content = getContent();
      }

      function send(change) {
        queue.push(change);
      }

      function updateAudience(audience) {
        updateStatus(`${audience} watching`);
      }

      connection.on('connected', () => {
        console.log('connected');
        let editor = createEditor(document.querySelector('#editor'));
        setInterval(() => flush(() => editor.getValue()), 200);
        editor.on('change', e => send(e));
        updateAudience(audience);
      });

      connection.on('id', updateStreamId);

      connection.on('sync', userId => connection.sendAll(userId, content, version));

      connection.on('joined', () => {
        updateAudience(++audience);
      });

      connection.on('left', () => {
        updateAudience(--audience);
      });
    }

    function watch(url, stream) {
      let buffer = new Buffer();
      let syncing = false;
      let connection = new Connection(new WebSocket(`${url}/?join=${stream}`));
      let editor;
      function sync() {
        if (syncing) return;
        connection.sync();
        syncing = true;
      }

      function applyChanges() {
        for (let c = buffer.pop(); c; c = buffer.pop())
          c.changes.forEach(cc => editor.getSession().getDocument().applyDelta(cc));
        editor.clearSelection();
      }

      function newChanges(changes, version) {
        if (!buffer.push({ changes: changes, version: version })) sync();
        applyChanges();
      }

      function allContent(content, version) {
        editor.setValue(content);
        editor.clearSelection();
        buffer.forceUpdate(version);
        syncing = false;
        applyChanges();
      }

      updateStreamId(stream);
      connection.on('connected', () => {
        console.log('connected');
        editor = createEditor(document.querySelector('#editor'), true);
        updateStatus('Watching');
        sync();
      });
      connection.on('changes', ([changes, version]) => newChanges(changes, version));
      connection.on('all', ([content, version]) => allContent(content, version));
      connection.on('stopped', () => updateStatus('Stopped'));
    }

    axios.get('/codestream').then(res => {
      let stream = location.hash.slice(1);
      let url = res.data;
      if (!stream) startStream(url);
      else watch(url, stream);
    });
  </script>
</body>

</html>